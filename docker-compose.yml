# Keen-One Astronomy Stack
# Docker Compose for INDI Server and Astronomy Tools
#
# This stack provides:
# - INDI Server for telescope control (with OnStep LX200 driver)
# - KStars/Ekos desktop accessible via web browser (port 3000)
# - Connects to OnStepX mount via TCP/IP
#
# Usage:
#   docker compose up -d
#
# Access KStars:
#   Open http://localhost:3000 in your browser
#   Username: abc (or set via ABC_USER env var)
#   Password: none by default
#
# INDI Server:
#   Port: 7624 (INDI protocol)
#
# Mount Connection:
#   KStars connects to INDI at localhost:7624 (inside container network)
#   INDI driver connects to OnStepX mount at ${ONSTEP_IP}:${ONSTEP_PORT}

services:
  # ==========================================================================
  # INDI Server - Core telescope control with OnStep driver
  # ==========================================================================
  indiserver:
    image: silfreed/indilib:latest
    container_name: indiserver
    restart: unless-stopped
    ports:
      - "7624:7624"
    environment:
      - TZ=${TIMEZONE:-Europe/London}
    volumes:
      - ./indi/config:/root/.indi
    # Start INDI server with OnStep LX200 driver
    # The driver connects to the mount via TCP (configured in INDI client)
    command: ["-v", "indi_lx200_OnStep"]
    # Additional drivers available in this image:
    # indi_lx200basic, indi_lx200generic, indi_simulator_telescope
    # indi_asi_ccd, indi_qhy_ccd (for cameras)
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "7624"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ==========================================================================
  # Astronomy Desktop - KStars + Stellarium accessible via web browser
  # ==========================================================================
  # Provides full Linux desktop with pre-configured astronomy software
  # Access at http://localhost:3000
  #
  # Included software:
  # - KStars/Ekos: Full astrophotography suite with INDI support
  # - Stellarium: Planetarium with telescope control
  # - INDI tools: Command-line INDI utilities
  #
  astronomy-desktop:
    image: linuxserver/webtop:ubuntu-kde
    container_name: astronomy-desktop
    restart: unless-stopped
    security_opt:
      - seccomp:unconfined
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TIMEZONE:-Europe/London}
      - SUBFOLDER=/
      - TITLE=Astronomy Desktop
      # Install astronomy software on startup
      - DOCKER_MODS=linuxserver/mods:universal-package-install
      - INSTALL_PACKAGES=kstars stellarium indi-bin
    volumes:
      - astronomy-desktop-config:/config
      # Pre-configured settings (copied on first boot via custom-cont-init.d)
      - ./config/stellarium:/defaults/stellarium:ro
      - ./config/kstars:/defaults/kstars:ro
      # Only mount init scripts (test scripts are in scripts/test/)
      - ./scripts/init:/custom-cont-init.d:ro
    ports:
      - "3000:3000"   # Web desktop (HTTP)
      - "3001:3001"   # Web desktop (HTTPS)
    shm_size: "1gb"
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    depends_on:
      - indiserver

  # ==========================================================================
  # Astrometry.net - Local plate solving (optional, large download)
  # ==========================================================================
  # Uncomment to enable plate solving. First run downloads ~2GB of index files.
  #
  # astrometry:
  #   image: dm90/astrometry:latest
  #   container_name: astrometry
  #   restart: unless-stopped
  #   ports:
  #     - "8090:8090"
  #   environment:
  #     - TZ=${TIMEZONE:-Europe/London}
  #   volumes:
  #     - astrometry-data:/data
  #   labels:
  #     - "com.centurylinklabs.watchtower.enable=true"

volumes:
  astronomy-desktop-config:
    name: astronomy-desktop-config
  astrometry-data:
    name: astronomy-astrometry-data

networks:
  default:
    name: astronomy
