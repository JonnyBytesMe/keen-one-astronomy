# ============================================================================
# Keen-One Astronomy Stack
# Docker Compose for INDI Server and Astronomy Tools
# ============================================================================
#
# This stack provides:
# - INDI Server for telescope control (with OnStep LX200 driver)
# - Web-accessible Linux desktop with KStars/Ekos and Stellarium
# - Auto-configuration of telescope control in both applications
# - Self-test diagnostics for troubleshooting
#
# Quick Start:
#   1. Copy .env.example to .env and configure your settings
#   2. Run: docker compose up -d
#   3. Open: http://localhost:3000 (or https://localhost:3001)
#
# For Portainer:
#   - Paste this file into Portainer's stack editor
#   - Configure environment variables in Portainer's UI
#   - Deploy the stack
#
# ============================================================================

services:
  # ==========================================================================
  # INDI Server - Core telescope control with OnStep driver
  # ==========================================================================
  # Runs the INDI protocol server with LX200 OnStep driver
  # Other containers connect to this for telescope control
  #
  indiserver:
    image: silfreed/indilib:latest
    container_name: indiserver
    restart: unless-stopped
    ports:
      - "7624:7624"
    environment:
      - TZ=${TIMEZONE:-Europe/London}
    volumes:
      - indi-config:/root/.indi
    # Start INDI server with OnStep LX200 driver
    # The driver connects to the mount via TCP (configured in INDI client)
    command: ["-v", "indi_lx200_OnStep"]
    # Additional drivers available in this image:
    # indi_lx200basic, indi_lx200generic, indi_simulator_telescope
    # indi_asi_ccd, indi_qhy_ccd (for cameras)
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    healthcheck:
      test: ["CMD-SHELL", "echo '<getProperties version=\"1.7\"/>' | timeout 5 cat > /dev/tcp/localhost/7624 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - astronomy

  # ==========================================================================
  # Astronomy Desktop - KStars + Stellarium accessible via web browser
  # ==========================================================================
  # Provides full Linux desktop with pre-configured astronomy software
  # Access at http://localhost:3000 or https://localhost:3001
  #
  # Included software:
  # - KStars/Ekos: Full astrophotography suite with INDI support
  # - Stellarium: Planetarium with telescope control
  # - INDI tools: Command-line INDI utilities
  #
  astronomy-desktop:
    image: linuxserver/webtop:ubuntu-kde
    container_name: astronomy-desktop
    restart: unless-stopped
    security_opt:
      - seccomp:unconfined
    environment:
      # LinuxServer.io base settings
      - PUID=1000
      - PGID=1000
      - TZ=${TIMEZONE:-Europe/London}
      - SUBFOLDER=/
      - TITLE=Astronomy Desktop
      # Install astronomy software on startup
      - DOCKER_MODS=linuxserver/mods:universal-package-install
      - INSTALL_PACKAGES=kstars stellarium indi-bin netcat-openbsd bc
      # =======================================================================
      # Astronomy Stack Configuration
      # =======================================================================
      # Logging: 0=ERROR, 1=WARN, 2=INFO, 3=DEBUG
      - LOG_LEVEL=${LOG_LEVEL:-3}
      # INDI Server (usually leave as default for Docker networking)
      - INDI_HOST=${INDI_HOST:-indiserver}
      - INDI_PORT=${INDI_PORT:-7624}
      # Mount connection (leave MOUNT_IP blank for auto-discovery)
      - MOUNT_IP=${MOUNT_IP:-}
      - MOUNT_PORT=${MOUNT_PORT:-9999}
      - MOUNT_DRIVER=${MOUNT_DRIVER:-LX200 OnStep}
      # Location (leave blank to use GPS from mount)
      - USE_GPS_LOCATION=${USE_GPS_LOCATION:-true}
      - LATITUDE=${LATITUDE:-}
      - LONGITUDE=${LONGITUDE:-}
      - ELEVATION=${ELEVATION:-}
      # Self-test settings
      - SELF_TEST_ON_BOOT=${SELF_TEST_ON_BOOT:-true}
      - SELF_TEST_ON_RESTART=${SELF_TEST_ON_RESTART:-false}
    volumes:
      - astronomy-desktop-config:/config
      # Mount scripts directories
      - ./scripts/init:/custom-cont-init.d:ro
      - ./scripts/test:/scripts:ro
    ports:
      - "3000:3000"   # Web desktop (HTTP)
      - "3001:3001"   # Web desktop (HTTPS)
    shm_size: "1gb"
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    healthcheck:
      test: ["CMD", "bash", "/scripts/health-check.sh"]
      interval: 60s
      timeout: 15s
      retries: 3
      start_period: 120s
    depends_on:
      indiserver:
        condition: service_healthy
    networks:
      - astronomy

  # ==========================================================================
  # Astrometry.net - Local plate solving (optional)
  # ==========================================================================
  # Uncomment to enable plate solving. First run downloads ~2GB of index files.
  # Access at http://localhost:8090
  #
  # astrometry:
  #   image: dm90/astrometry:latest
  #   container_name: astrometry
  #   restart: unless-stopped
  #   ports:
  #     - "8090:8090"
  #   environment:
  #     - TZ=${TIMEZONE:-Europe/London}
  #   volumes:
  #     - astrometry-data:/data
  #   labels:
  #     - "com.centurylinklabs.watchtower.enable=true"
  #   networks:
  #     - astronomy

# ============================================================================
# Volumes
# ============================================================================
volumes:
  astronomy-desktop-config:
    name: astronomy-desktop-config
  indi-config:
    name: astronomy-indi-config
  astrometry-data:
    name: astronomy-astrometry-data

# ============================================================================
# Networks
# ============================================================================
networks:
  astronomy:
    name: astronomy
    driver: bridge
