# Keen-One Astronomy Stack
# Docker Compose for INDI Server and Astronomy Tools
#
# This stack provides:
# - INDI Server for telescope control
# - INDI Web Manager for browser-based driver management
# - Astrometry.net for plate solving (optional)
#
# Usage:
#   docker compose up -d
#
# Connect from Stellarium/KStars:
#   Host: localhost (or your Docker host IP)
#   Port: 7624 (INDI protocol)
#
# Web Interface:
#   http://localhost:8624 (INDI Web Manager)

services:
  # ==========================================================================
  # INDI Server - Core telescope control
  # ==========================================================================
  indiserver:
    image: indilib/indi-full:latest
    container_name: indiserver
    restart: unless-stopped
    network_mode: host  # Required for USB device passthrough and multicast
    privileged: true    # Required for serial/USB device access
    environment:
      - TZ=${TIMEZONE:-Europe/London}
    volumes:
      - ./indi/config:/root/.indi
      - /dev:/dev  # Pass through all devices for USB/serial access
    command: >
      indiserver -v
      indi_lx200_OnStep
    # Add more drivers as needed:
    # indi_asi_ccd        - ZWO cameras
    # indi_qhy_ccd        - QHY cameras
    # indi_gpsd           - GPS
    # indi_eqmod_telescope - EQMod mounts
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ==========================================================================
  # INDI Web Manager - Browser-based driver management
  # ==========================================================================
  indi-web:
    image: indilib/indi-web:latest
    container_name: indi-web
    restart: unless-stopped
    ports:
      - "8624:8624"
    environment:
      - TZ=${TIMEZONE:-Europe/London}
      - INDI_HOST=host.docker.internal  # Connect to indiserver on host network
      - INDI_PORT=7624
    volumes:
      - ./indi/web-config:/root/.indi
    depends_on:
      - indiserver
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      # Traefik labels (uncomment if using Traefik reverse proxy)
      # - "traefik.enable=true"
      # - "traefik.http.routers.indi-web.rule=Host(`astronomy.example.com`)"
      # - "traefik.http.routers.indi-web.entrypoints=https"
      # - "traefik.http.routers.indi-web.tls=true"
      # - "traefik.http.services.indi-web.loadbalancer.server.port=8624"

  # ==========================================================================
  # Astrometry.net - Local plate solving (optional, large download)
  # ==========================================================================
  # Uncomment to enable plate solving. First run downloads ~2GB of index files.
  #
  # astrometry:
  #   image: dm90/astrometry:latest
  #   container_name: astrometry
  #   restart: unless-stopped
  #   ports:
  #     - "8090:8090"
  #   environment:
  #     - TZ=${TIMEZONE:-Europe/London}
  #   volumes:
  #     - astrometry-data:/data
  #   labels:
  #     - "com.centurylinklabs.watchtower.enable=true"

volumes:
  astrometry-data:
    name: astronomy-astrometry-data

networks:
  default:
    name: astronomy
