# ============================================================================
# Keen-One Astronomy Stack - Portainer Edition
# ============================================================================
# Self-contained Docker Compose for Portainer deployment
#
# INSTRUCTIONS:
#   1. Copy this entire file into Portainer's Stack editor
#   2. Configure environment variables in Portainer's UI
#   3. Deploy the stack
#   4. Access at https://your-server:3001
#
# Pre-built image includes all software - no downloads on startup!
# ============================================================================

services:
  # ==========================================================================
  # INDI Server - Telescope Control
  # ==========================================================================
  indiserver:
    image: silfreed/indilib:latest
    container_name: indiserver
    restart: unless-stopped
    ports:
      - "7624:7624"
    environment:
      - TZ=${TIMEZONE:-Europe/London}
    volumes:
      - indi-config:/root/.indi
    command: ["-v", "indi_lx200_OnStep"]
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    healthcheck:
      test: ["CMD-SHELL", "echo '<getProperties version=\"1.7\"/>' | timeout 5 cat > /dev/tcp/localhost/7624 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - astronomy

  # ==========================================================================
  # Astronomy Desktop - Pre-built image with all software
  # ==========================================================================
  # Includes: KStars, Stellarium, ASTAP (with D50 catalog), INDI tools
  #
  astronomy-desktop:
    image: ghcr.io/jonnybytesme/keen-one-astronomy:latest
    container_name: astronomy-desktop
    restart: unless-stopped
    security_opt:
      - seccomp:unconfined
    environment:
      # LinuxServer.io base settings
      - PUID=1000
      - PGID=1000
      - TZ=${TIMEZONE:-Europe/London}
      - SUBFOLDER=/
      - TITLE=Astronomy Desktop
      # =====================================================================
      # Astronomy Stack Configuration
      # =====================================================================
      # Logging: 0=ERROR, 1=WARN, 2=INFO, 3=DEBUG
      - LOG_LEVEL=${LOG_LEVEL:-2}
      # INDI Server (usually leave as default)
      - INDI_HOST=${INDI_HOST:-indiserver}
      - INDI_PORT=${INDI_PORT:-7624}
      # Mount IP (leave blank for auto-discovery, or set to your mount's IP)
      - MOUNT_IP=${MOUNT_IP:-}
      - MOUNT_PORT=${MOUNT_PORT:-9999}
      - MOUNT_DRIVER=${MOUNT_DRIVER:-LX200 OnStep}
      # Location (leave blank to use GPS from mount)
      - USE_GPS_LOCATION=${USE_GPS_LOCATION:-true}
      - LATITUDE=${LATITUDE:-}
      - LONGITUDE=${LONGITUDE:-}
      - ELEVATION=${ELEVATION:-}
      # Self-test settings
      - SELF_TEST_ON_BOOT=${SELF_TEST_ON_BOOT:-false}
      # =====================================================================
      # Multi-Client Sharing (Selkies-GStreamer)
      # =====================================================================
      - SELKIES_ENABLE_SHARING=true
      - SELKIES_ENABLE_COLLAB=true
    volumes:
      - astronomy-desktop-config:/config
    ports:
      - "3000:3000"   # Web desktop (HTTP)
      - "3001:3001"   # Web desktop (HTTPS)
    shm_size: "1gb"
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 3000 || exit 1"]
      interval: 60s
      timeout: 15s
      retries: 3
      start_period: 120s
    depends_on:
      indiserver:
        condition: service_healthy
    networks:
      - astronomy

volumes:
  astronomy-desktop-config:
    name: astronomy-desktop-config
  indi-config:
    name: astronomy-indi-config

networks:
  astronomy:
    name: astronomy
    driver: bridge
